:javascript
  function RibbonController(){
    this.diagram = null;
    this.graph = null;
    this.filter = null;
    this.data_format = #{@diagram.data_format.inspect};
    this.format_converter = new RibbonFormatConverter(this.data_format);

    this.data = this.format_converter.convert(
      #{@diagram.data_files.map do |df| { "name" => df.name, "data" => Paperclip.io_adapters.for(df.data_file).read } end.to_json }
    );
    this.clean_data();

    this.filter = new RibbonFilter(this.data);

    this.initialize();
    this.register_form_events();
  }

  RibbonController.prototype = {
    register_form_events: function(){
      var controller = this;

      $("#control_toggle").click(function(){
        $("#controls").animate({width: 'toggle'});
      });

      $(".wrap").addClass("wrap-wide").removeClass("wrap");


      $("#time_select_update").click(function(){
        controller.graph.views = $("#time_select").val();
        controller.diagram.total_width = controller.graph.views.length * 300 + 300;
        controller.recalculate_and_redraw();
      });

      $("#deselect_links").click(function(){
        controller.graph.select_none();
        controller.diagram.draw();
        return false;
      });

      $(".select_all").click(function(){
        $("#" + $(this).attr("id").replace("_select_all", "") + " option").attr('selected', true);
        $("#" + $(this).attr("id").replace("_select_all", "")).focus();
        return false;
      });

      $(".select_none").click(function(){
        $("#" + $(this).attr("id").replace("_select_none", "") + " option").attr('selected', false);
        $("#" + $(this).attr("id").replace("_select_none", "")).focus();
        return false;
      });

      $('select').each(function(){
          var select = $(this), values = {};
          $('option',select).each(function(i, option){
              values[option.value] = option.selected;
          }).click(function(event){
              values[this.value] = !values[this.value];
              $('option',select).each(function(i, option){
                  option.selected = values[option.value];
              });
          });
      });

      $("#toggle_vis_desc").click(function(){
        $("#vis_desc").slideToggle(500, function(){
          if ($("#vis_desc").is(':visible')){
            $("#toggle_vis_desc").html("Hide Description");
          } else {
            $("#toggle_vis_desc").html("Show Description");
          }
        });


      });

      $(".apply_filter").click(controller.recalculate_and_redraw);

      var instructions_showing = true;

      $("#toggle_instructions").click(function(e){
        e.preventDefault();

        if (instructions_showing){
          $(this).text("Show Instructions");
          $("#instructions").slideUp();
        }else{
          $("#instructions").slideDown();
          $(this).text("Hide Instructions");
        }
        instructions_showing = !instructions_showing;
      });
    },

    initialize: function(){
      //this.filter.build_time_selectors();

      //Create the graph and the diagram
      this.graph = new RibbonGraph(this.data, this.filter);
      this.diagram = new RibbonDiagram(this.graph);

      //Draw the diagram
      this.diagram.draw();
    },

    recalculate_and_redraw: function(){
      var controller = ribbon_controller;

      $.blockUI({ message: '<h1>Recalculating Graph</h1>', fadeIn: 10 });

      setTimeout(function(){
        controller.graph.reset_node_and_link_values();
        controller.graph.build();
        controller.diagram.draw();
        $.unblockUI();
      }, 50);
    },

    clean_data: function(){
      var students_with_no_records = []

      this.data["STUDENTS"].forEach(function(s){
        if (s["RECORDS"].length == 0)
          students_with_no_records.push(s);
      });

      if (students_with_no_records.length > 0){
        var swnr_ids = [];

        students_with_no_records.forEach(function(s){
          swnr_ids.push(s["ID"]);
        });

        $("#flash").append('<div id="error">Warning: '+swnr_ids.length+' students in your dataset did not have any records. They have not been included in the diagram. Their IDs are:'+swnr_ids.join(",")+'</div>');

        this.data["STUDENTS"] = this.data["STUDENTS"].filter(function(s){
          return s["RECORDS"].length > 0;
        });
      }
    }
  }

  var ribbon_controller = null;

  window.onload = function(){
    ribbon_controller = new RibbonController();
  }


